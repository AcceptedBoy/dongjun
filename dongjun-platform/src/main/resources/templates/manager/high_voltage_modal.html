<div id="upload_modal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"
                    aria-hidden="true">×</button>
            <h3 id="myModalLabel">上传excel</h3>
        </div>
        <div class="modal-body">
            <form class="form-horizontal" enctype="multipart/form-data" onsubmit="return false">
                </div> -->
                <div class="control-group">
                    <label class="control-label" for="file">文件位置</label>
                    <div class="controls">
                        <input type="file" id="file" name="file" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn" data-dismiss="modal" aria-hidden="true">取消</button>
                    <button id="uploadxls_btn" class="btn btn-primary" onclick="modal.uploadFile()">添加</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add_Switch_Modal -->
<div id="add_switch_modal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"
                aria-hidden="true">×</button>
        <h3>添加开关</h3>
    </div>
    <div class="modal-body">
        <div id="add_switch_form" class="form-horizontal">
            <div class="control-group">
                <label class="control-label" for="inputDeviceNumber">设备号码</label>
                <div class="controls">
                    <input type="text" id="inputDeviceNumber" name="deviceNumber" />
                </div>
            </div>
            <div class="control-group">
                <label class="control-label" for="inputName">开关名称</label>
                <div class="controls">
                    <input type="text" id="inputName" name="name" />
                </div>
            </div>

            <div class="control-group">
                <label class="control-label" for="inputAddress">地址</label>
                <div class="controls">
                    <input type="text" id="inputAddress" name="address" />
                </div>
            </div>
            <div class="control-group">
                <label class="control-label" for="inputSim">SIM</label>
                <div class="controls">
                    <input type="text" id="inputSim" name="simNumber" />
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" data-dismiss="modal" aria-hidden="true">取消</button>
                <button id="add_switch_confirm_btn" class="btn btn-primary"
                        aria-hidden="true" onclick="modal.save(true)">添加</button>
            </div>
        </div>
    </div>
</div>
    <!-- <addSwitchModal></addSwitchModal> -->

    <!-- Edit_Switch_Modal -->
<div id="edit_switch_modal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"
                aria-hidden="true">×</button>
        <h3>编辑开关</h3>
    </div>
    <div class="modal-body">
        <div id="edit_switch_form" class="form-horizontal">
            <div class="control-group">
                <label class="control-label" for="editDeviceNumber">设备号码</label>
                <div class="controls">
                    <input type="text" id="editDeviceNumber" name="deviceNumber" readOnly="true" />
                </div>
            </div>
            <div class="control-group">
                <label class="control-label" for="editName">开关名称</label>
                <div class="controls">
                    <input type="text" id="editName" name="name" />
                </div>
            </div>
            <div class="control-group">
                <label class="control-label" for="editAddress">地址</label>
                <div class="controls">
                    <input type="text" id="editAddress" name="address" />
                </div>
            </div>

            <div class="control-group">
                <label class="control-label" for="editSim">SIM</label>
                <div class="controls">
                    <input type="text" id="editSim" name="simNumber" />
                </div>
            </div>
            <div class="hide control-group">
                <label class="control-label" for="editId">Id</label>
                <div class="controls">
                    <input type="text" id="editId" name="id" />
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" data-dismiss="modal" aria-hidden="true">取消</button>
                <button id="edit_switch_confirm_btn" class="btn btn-primary"
                        aria-hidden="true" onclick="modal.save(false)">确定</button>
            </div>
        </div>

    </div>
</div>
<!--delete Modal -->
<div id="del_switch_modal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"
                aria-hidden="true">×</button>
        <h3 id="myModalLabel">警告</h3>
    </div>
    <div class="modal-body">
        <p>您确定要删除这个开关吗？请慎重考虑</p>
    </div>
    <div class="modal-footer">
        <button class="btn" data-dismiss="modal" aria-hidden="true">关闭</button>
        <a id="del_confirm_btn" class="btn btn-danger" data-dismiss="modal"
           aria-hidden="true" onclick="modal.sureDel()">删除</a>
    </div>
</div>

<!-- new security_modal -->
<div id="security_modal" class="modal hide fade" tabindex="-1"
  role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal"
      aria-hidden="true">×</button>
    <h3 id="myModalLabel">安全认证</h3>
  </div>
  <div class="modal-body">
    <div id="upload_form" class="form-horizontal">
      <div class="control-group">
        <h5 style="text-align: center">您正在修改开关状态，请输入验证密码</h5>
      </div>
      <div class="control-group">
        <label class="control-label" for="controlCode">验证密码：</label>
        <div class="controls">
          <input type="password" id="controlCode" name="controlCode" placeholder="请输入密码" />
          <span class="add-on"><i class="icon-eye-close" onclick="modal.pwViewer(this)" style="cursor: pointer;"></i></span>
        </div>
      </div>
      <div class="control-group">
        <h5 style="text-align: center" id="noticeMsg">

        </h5>
      </div>
      <div class="modal-footer">
        <button id="cancel_control" class="btn" data-dismiss="modal" aria-hidden="true">取消</button>
        <button id="secu_confirm_btn" class="btn btn-primary" onclick="modal.validate()">执行</button>
      </div>
    </div>
  </div>
</div>

<script>
  var modal = function(){
    var urls = {};
    var completeFnc = null;
    var nowTargetId = -1;
    var validate = null;
    var ctrlSign = -1;
    return {
      setOption: function(o) {
        completeFnc = o.completeFnc
        urls = {
          add: o.url.add,
          edit: o.url.edit,
          del: o.url.del,
          upload: o.url.upload,
          validate: o.url.validate,
          alterStatus: o.url.alterStatus
        }
      },
      addSwitch: function(line) {
        var inputs = $('#add_switch_modal').find('input')
        for (var i = inputs.length - 1; i >= 0; i--) {
          var input = inputs[i]
          input.value = ''
        }
      },
      save: function(isAdd) {
        var addModal = isAdd ? $('#add_switch_modal') : $('#edit_switch_modal')
        var inputs = addModal.find('input')
        var data = {}
        for (var i = inputs.length - 1; i >= 0; i--) {
          var input = inputs[i]
          if(!$.trim(input.value)) {
            if(input.id != 'inputId') {
              input.focus()
              console.log(input.id)
              alert('您还有选项暂未填写')
              return
            }
          }
          var dataName = (input.id).replace(/(input|edit)(\w)/, function(match, $1, $2) {
            return $2.toLowerCase()
          })
          data[dataName] = input.value
        }

        var params = {
          'name' : data.name,
          'platformId' : selectManager.getCompany(),
          'address' : data.address,
          'simNumber' : data.sim,
          'deviceNumber': data.deviceNumber
        };

        if(!isAdd) {
        	params['id'] = data.id
        }

        console.log(params)
        $.ajax({
          type : 'post',
          url : isAdd ? urls.add : urls.edit,
          async : false,
          data : params,
          success : function(data) {

            if(data.success){
              addModal.find('.close').click()
              completeFnc(parseInt(data.text))
            } else {
              alert(data.text)
            }
          }
        })
      },
      editSwitch: function(target) {
        var inputs = $('#edit_switch_modal').find('input')
        var colums = target.closest('tr').find('td')
        for (var i = inputs.length - 1; i >= 0; i--) {
          var input = inputs[i]
          input.value = colums[i].innerHTML
        }
      },
      delSwitch: function(targetId) {
        nowTargetId = targetId
      },
      sureDel: function() {
        $.ajax({
          type: 'post',
          url: urls.del,
          data: {
            'switchId': nowTargetId
          },
          success: function(data) {
            if(data.success) {
              alert('操作成功')
              completeFnc(data.text)
            } else {
              alert(data.text)
            }
          }
        })
      },
      uploadFile: function(e) {
        var ev = e || window.event
        ev.preventDefault()
        var uploadModal = $('#upload_modal')
        var platformId = selectManager.getCompany()
        var file = uploadModal.find('#file')[0].files[0]
        if(!file) {
          alert('请选择文件')
          return
        }
        var fD = new FormData()
        fD.append('platformId', platformId)
        fD.append('file', file)
        // test
        for (var key of fD.keys()) {
           console.log(key);
        }

        $.ajax({
          url: urls.upload,
          type: 'POST',
          data: fD,
          processData: false,
          contentType: false,
          beforeSend: function(data) {
            console.log(`发送...`)
            console.log(data)
          },
          success: function(data) {
            console.log(data)
            if(data.success){
            	completeFnc(parseInt(data.text))
            	uploadModal.find('.close').click()
            	alert('操作成功')
            } else {
            	alert('失败')
            }

          },
          error: function(data) {
            console.log(data)
            alert('出错了')
          }
        })
      },
      pwViewer: function(self) {
        var pwInput = $(self).parent().prev()[0]
        console.log(pwInput.type)
        if(pwInput.type == 'password') {
          pwInput.type = 'text'
          self.className = 'icon-eye-open'
        } else {
          pwInput.type = 'password'
          self.className = 'icon-eye-close'
        }
      },
      switchCtrl: function(o) {
        var secModal = $("#security_modal")
        var pwNode = secModal.find('#controlCode')
        pwNode.val('')
        if(pwNode.attr('type') != 'password') {
          pwNode.attr('type','password')
          var pwViewer = pwNode.next().find('i')
          pwViewer.attr('class', 'icon-eye-close')
          pwViewer = null
        }
        pwNode[0].focus()
        secModal.find('#noticeMsg').html('')
        $("#security_modal").modal('show')
        nowTargetId = o.switchId
        validate = o.validate
        ctrlSign = o.sign
      },
      validate: function() {
        var _self = this
        var secModal = $("#security_modal")
        var ctrlCode = secModal.find('#controlCode').val()
        var msgNode = secModal.find('#noticeMsg')
        $.ajax({
          url: urls.validate,
          type: 'POST',
          data: {
            controlCode: ctrlCode
          },
          success: function(res) {
            res = typeof res == 'string' ? JSON.parse(res) : res
            if(res) {
              msgNode.html('<h5 class="successMsg">操作成功, 正在修改状态，请稍等...</h5>')

              if(_self.switchStatusAlter()) {
                msgNode.html('<h5 class="successMsg">修改状态成功</h5>')
                setTimeout(function(){
                  secModal.modal('hide')
                  validate()
                }, 500)
              } else {
                msgNode.html('<h5 class="errorMsg">修改状态失败</h5>')
              }

            } else {
              msgNode.html('<h5 class="errorMsg">密码错误</h5>')
            }
          },
          error: function(res) {
            msgNode.html('<h5 class="errorMsg">出错了，请联系后台= =.</h5>')
          }
        })
      },
      switchStatusAlter: function() {
        var isSuccess = false
        $.ajax({
          url: urls.alterStatus,
          type: 'POST',
          async: false,
          data: {
            switchId: nowTargetId,
            type: 1,
            sign: ctrlSign
          },
          success: function(res) {
            res = typeof res == 'string' ? JSON.parse(res) : res
            if(res == 'success') {
              isSuccess = true
            } else {
              isSuccess = false
            }
          }
        })
        return isSuccess
      }
    }
  }()
</script>
