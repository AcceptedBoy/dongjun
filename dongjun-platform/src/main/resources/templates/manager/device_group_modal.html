<div id="edit_device_group_modal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal"
            aria-hidden="true">×</button>
    <h3>编辑</h3>
  </div>
  <div class="modal-body">
    <div class="form-horizontal">
      <!-- action="edit_switch" -->
      <div class="control-group">
          <label class="control-label" for="inputName">组别名称</label>
          <div class="controls">
              <input type="text" id="inputName" name="name" />
          </div>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">取消</button>
    <button id="edit_device_group_confirm_btn" class="btn btn-primary"
            aria-hidden="true">确定</button>
  </div>
</div>

<script>
  ;(function() {
    DeviceGroup.module({
      name: 'device_group_modal',
      module: function (obs, mStore) {
        var urls = {
          edit: mStore.group.api.edit,
          del: mStore.group.api.del
        }
        var actions = {
          add: '',
          edit: '',
          del: ''
        }
        var status = {
          isAdd: true
        }
        var panel = {
          edit: $('#edit_device_group_modal')
        }
        var $dom = {
          edit_confirm: $('#edit_device_group_confirm_btn')
        }
        var nowId = {
          id: -1
        }
        return {
          init: function() {
            this.__listen()
            return this
          },
          __listen: function () {
            $dom.edit_confirm.on('click', this.save.bind(this))
          },
          add: function() {
            status.isAdd = true
            this.clearForm()
            panel.edit.modal('show')
          },
          clearForm: function() {
            var inputs = panel.edit.find('input')
            for (var i = inputs.length - 1; i >= 0; i--) {
              var input = inputs[i]
              input.value = ''
            }
          },
          save: function() {
            var curModal = panel.edit
            var inputs = curModal.find('input')
            var data = {}
            for (var i = inputs.length - 1; i >= 0; i--) {
              var input = inputs[i]
              if(!$.trim(input.value)) {
                input.focus()
                alert('您还有选项暂未填写')
                return
              }
              data[input.name] = input.value
            }
    
            var params = data
            params.companyId = mStore.cascader.companyId
            if(!status.isAdd) {
              params['id'] = nowId.id
            }
    
            $.ajax({
              type : 'POST',
              url : urls.edit,
              data : params,
              success : function(data) {
                if(data.success) {
                  if(data.type != 'SUCCESS') {
                    alert(data.text)
                  } else {
                    // 重新加载多级联动搜索的最后一项
                    obs.emit('reload_cas', {
                      index: 2
                    })
                    alert('操作成功')
                    curModal.modal('hide')
                  }
                } else {
                  alert('失败 ')
                }
              }
            })
          },
          edit: function(data) {
            status.isAdd = false
            var inputs = panel.edit.find('input')
            nowId.id = data.id
            Array.prototype.forEach.call(inputs, function(item) {
              item.value = data[item.name] || ''
            })
            panel.edit.modal('show')
          },
          del: function(id) {
            nowId.id = id
            Popup.Confirm({
              title: '警告',
              text: '您确定要删除吗？请慎重考虑',
              cancelText: '关闭',
              successText: '删除',
              success: this.sureDel.bind(this)
            })
          },
          sureDel: function() {
            $.ajax({
              type: 'POST',
              url: urls.del,
              data: {
                'id': nowId.id
              },
              success: function(data) {
                if(data.success) {
                  if(data.type == 'WARNING') {
                    alert(data.text)
                  } else {
                    // 重新加载多级联动搜索的最后一项
                    obs.emit('reload_cas', {
                      index: 2
                    })
                    alert('操作成功')
                  }
                } else {
                  alert('失败')
                }
              }
            })
          }
        }
      },
      on: {
        init_device_group_modal: function (self, opts) {
          self.init(opts)
        },
        add_device_group: function (self) {
          self.add()
        },
        edit_device_group: function (self, groupData) {
          self.edit(groupData)
        },
        del_device_group: function (self, id) {
          self.del(id)
        }
      },
      hook: {
        afterActive: function (self) {
          self.init()
        }
      }
    })
  }())
</script>